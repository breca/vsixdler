name: Sync Extensions

on:
  schedule:
    - cron: "0 4 * * 0" # Sundays 04:00 UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (resolve versions but skip downloads)"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build -o vsixdler .

      - name: Derive release tag
        id: tag
        run: |
          branch="${GITHUB_REF_NAME}"
          slug="$(echo "$branch" | sed 's/[^a-zA-Z0-9._-]/-/g')"
          tag="${slug}/sync-$(date -u +%Y%m%d)-${GITHUB_RUN_NUMBER}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "Release tag: $tag"

      - name: Download extensions
        run: |
          flags="-v"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            flags="$flags --dry-run"
          fi
          ./vsixdler download $flags

      - name: Create release
        if: inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            --title "Extensions sync ${{ steps.tag.outputs.tag }}" \
            --notes "Automated extension sync from branch \`${GITHUB_REF_NAME}\`." \
            ./vsix/*.vsix
